DESCRIPTION='Handle URL: POST a new templated handle'

source 'common.inc'

# TODO: This unit test tests only some basics.
function systemtest() (
  set -e
  # %2A is the asterisk '*'
  TEMPLATE=${TESTHANDLE}'_~**'
  ${CURL} --data-binary '@input_2.2_2' --header 'Content-Type: application/json' --dump-header "${TMPTEST}.hdr" "${BASEURL}/${TEMPLATE}"
  grep -P '^HTTP/1\.1 201 Created' "${TMPTEST}.hdr"
  HANDLE=$( grep -P '^Location:\s' <"${TMPTEST}.hdr" | grep -o -P 'https://epic\.sara\.nl/catchplus/'${TESTHANDLE}'_(\*|%2[aA])\S+' )
  [ $? -eq 0 ]
  ${CURL} --header 'Accept: application/json' "${HANDLE}" >"${TMPTEST}"
  ${CURL} --request 'DELETE' "${HANDLE}" || true
  grep -P '^\{"1":\{"type":"URL","data":"http:\\/\\/www\.sara\.nl\\/","timestamp":\d+\},"2":\{"type":"EMAIL","data":"pieterb@sara\.nl","timestamp":\d+\}\}$' "${TMPTEST}"
)
